<div class="container">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Automatic Faculty Timetable Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container py-4"></div>
    <h2 class="mb-4 text-center">Automatic Faculty Timetable Creator</h2>
    <!-- Department, Year, Semester Info -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="department" class="form-label">Department</label>
                    <select class="form-select" id="department" required>
                        <option value="" disabled selected>Select Department</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Information Technology">Information Technology</option>
                        <option value="Electronics and Communication">Electronics and Communication</option>
                        <option value="Electrical and Electronics">Electrical and Electronics</option>
                        <option value="Mechanical Engineering">Mechanical Engineering</option>
                        <option value="Civil Engineering">Civil Engineering</option>
                        <option value="Chemical Engineering">Chemical Engineering</option>
                        <option value="Biomedical Engineering">Biomedical Engineering</option>
                        <option value="Artificial Intelligence">Artificial Intelligence</option>
                        <option value="Data Science">Data Science</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="year" class="form-label">Year</label>
                    <select class="form-select" id="year" required onchange="updateSemesterOptions()">
                        <option value="" disabled selected>Select Year</option>
                        <option value="I Year">I Year</option>
                        <option value="II Year">II Year</option>
                        <option value="III Year">III Year</option>
                        <option value="IV Year">IV Year</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="semester" class="form-label">Semester</label>
                    <select class="form-select" id="semester" required>
                        <option value="" disabled selected>Select Semester</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="classSection" class="form-label">Section</label>
                    <select class="form-select" id="classSection" required>
                        <option value="" disabled selected>Select Section</option>
                        <option value="Section A">Section A</option>
                        <option value="Section B">Section B</option>
                        <option value="Section C">Section C</option>
                        <option value="Section D">Section D</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <script>
        function updateSemesterOptions() {
            const year = document.getElementById('year').value;
            const semester = document.getElementById('semester');
            let options = '<option value="" disabled selected>Select Semester</option>';
            if (year === "I Year") {
                options += '<option value="I Semester">I Semester</option>';
                options += '<option value="II Semester">II Semester</option>';
            } else if (year === "II Year") {
                options += '<option value="III Semester">III Semester</option>';
                options += '<option value="IV Semester">IV Semester</option>';
            } else if (year === "III Year") {
                options += '<option value="V Semester">V Semester</option>';
                options += '<option value="VI Semester">VI Semester</option>';
            } else if (year === "IV Year") {
                options += '<option value="VII Semester">VII Semester</option>';
                options += '<option value="VIII Semester">VIII Semester</option>';
            }
            semester.innerHTML = options;
        }
    </script>
    <div class="row g-4 mb-4">
        <!-- Theory Faculty Assignment -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">Add Theory Faculty</div>
                <div class="card-body">
                    <form id="timetableForm">
                        <div class="mb-3">
                            <label for="faculty" class="form-label">Faculty Name</label>
                            <select class="form-select" id="faculty" required>
                                <option value="" disabled selected>Select Theory Faculty Name</option>
                                <option value="Dr. A. Kumar">Dr. A. Kumar</option>
                                <option value="Prof. B. Sharma">Prof. B. Sharma</option>
                                <option value="Ms. C. Patel">Ms. C. Patel</option>
                                <option value="Mr. D. Singh">Mr. D. Singh</option>
                                <option value="Dr. E. Reddy">Dr. E. Reddy</option>
                                <option value="Mrs. F. Nair">Mrs. F. Nair</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <select class="form-select" id="subject" required>
                                <option value="" disabled selected>Select Theory Subject</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Computer Programming">Computer Programming</option>
                                <option value="Engineering Mechanics">Engineering Mechanics</option>
                                <option value="English">English</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="hours" class="form-label">Hours/Week</label>
                            <input type="number" class="form-control" id="hours" placeholder="Theory Hours/Week" min="1" max="10" required>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="addFaculty()">Add Faculty</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Lab Faculty Assignment -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">Add Lab Faculty</div>
                <div class="card-body">
                    <form id="labForm"></form>
                        <div class="mb-3">
                            <label for="labFaculty" class="form-label">Lab Faculty Name</label>
                            <select class="form-select" id="labFaculty" required>
                                <option value="" disabled selected>Select Lab Faculty Name</option>
                                <option value="Dr. A. Kumar">Dr. A. Kumar</option>
                                <option value="Prof. B. Sharma">Prof. B. Sharma</option>
                                <option value="Ms. C. Patel">Ms. C. Patel</option>
                                <option value="Mr. D. Singh">Mr. D. Singh</option>
                                <option value="Dr. E. Reddy">Dr. E. Reddy</option>
                                <option value="Mrs. F. Nair">Mrs. F. Nair</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="labSubject" class="form-label">Lab Subject</label>
                            <select class="form-select" id="labSubject" required>
                                <option value="" disabled selected>Select Lab Subject</option>
                                <option value="Physics Lab">Physics Lab</option>
                                <option value="Chemistry Lab">Chemistry Lab</option>
                                <option value="Programming Lab">Programming Lab</option>
                                <option value="Engineering Workshop">Engineering Workshop</option>
                                <option value="Electronics Lab">Electronics Lab</option>
                                <option value="Mechanical Lab">Mechanical Lab</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="labHours" class="form-label">Lab Hours/Week</label>
                            <input type="number" class="form-control" id="labHours" placeholder="Lab Hours/Week" min="1" max="10" required>
                        </div>
                        <button type="button" class="btn btn-success w-100" onclick="addLab()">Add Lab</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Faculty List and Upload -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-dark">Faculty Assignments</div>
                <div class="card-body">
                    <div id="facultyList"></div>
                    <button class="btn btn-warning mt-3" onclick="shuffleFaculties()">Shuffle Faculty</button>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white">Upload Faculty Excel</div>
                <div class="card-body">
                    <label for="excelFile" class="form-label">Upload Faculty Excel (.xlsx):</label>
                    <input type="file" class="form-control mb-2" id="excelFile" accept=".xlsx,.xls">
                    <div class="form-text mb-2">Columns: <b>Faculty Name</b>, <b>Subject</b>, <b>Hours/Week</b></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Generate Timetable Button (separate row) -->
        <div class="row mb-4">
            <div class="col-12">
                <button class="btn btn-success w-100" onclick="generateTimetable()">Generate Timetable</button>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>
    <div id="timetableResult"></div>
    <script>
        // Populate faculty dropdown from faculties array (unique names)
        function updateFacultyDropdown() {
            const facultySelect = document.getElementById('faculty');
            if (!facultySelect) return;
            // Get unique faculty names from faculties array
            const facultyNames = [...new Set(faculties.map(f => f.faculty).filter(name => name))];
            // Add default 6 names if not present
            const defaultNames = [
                "Dr. A. Kumar",
                "Prof. B. Sharma",
                "Ms. C. Patel",
                "Mr. D. Singh",
                "Dr. E. Reddy",
                "Mrs. F. Nair"
            ];
            defaultNames.forEach(name => {
                if (!facultyNames.includes(name)) facultyNames.push(name);
            });
            // Save current selection
            const currentValue = facultySelect.value;
            facultySelect.innerHTML = '<option value="" disabled selected>Select Theory Faculty Name</option>';
            facultyNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                facultySelect.appendChild(option);
            });
            // Restore previous selection if possible
            if (facultyNames.includes(currentValue)) {
                facultySelect.value = currentValue;
            }
        }
        // Update dropdown whenever faculties array changes
        // Call after renderFacultyList, addFaculty, addLab, handleExcelUpload, shuffleFaculties, removeFaculty
        const origRenderFacultyList = renderFacultyList;
        renderFacultyList = function() {
            origRenderFacultyList.apply(this, arguments);
            updateFacultyDropdown();
        };
        // Initial call
        document.addEventListener('DOMContentLoaded', updateFacultyDropdown);
    </script>
</div>
<script>
    const faculties = [];
    // 6 days (Day 1 to Day 6)
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    // 7 periods per day, with break after 2nd and 4th period
    const periods = ["1", "2", "Break", "3", "4", "Break", "5", "6", "7"];

    document.getElementById('excelFile').addEventListener('change', handleExcelUpload);

    function handleExcelUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            faculties.length = 0; // Clear existing
            for (let i = 1; i < json.length; i++) {
                const row = json[i];
                if (row && row[0] && row[1] && row[2]) {
                    faculties.push({
                        faculty: String(row[0]).trim(),
                        subject: String(row[1]).trim(),
                        hours: parseInt(row[2], 10)
                    });
                }
            }
            renderFacultyList();
            generateTimetable();
        };
        reader.readAsArrayBuffer(file);
    }

    function addFaculty() {
        const faculty = document.getElementById('faculty').value.trim();
        const subject = document.getElementById('subject').value.trim();
        const hours = parseInt(document.getElementById('hours').value, 10);

        if (faculty && subject && hours > 0) {
            faculties.push({ faculty, subject, hours });
            document.getElementById('faculty').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('hours').value = '';
            renderFacultyList();
        }
    }

    function addLab() {
        const faculty = document.getElementById('labFaculty').value.trim();
        const subject = document.getElementById('labSubject').value.trim();
        const hours = parseInt(document.getElementById('labHours').value, 10);

        if (faculty && subject && hours > 0) {
            faculties.push({ faculty, subject, hours, isLab: true });
            document.getElementById('labFaculty').value = '';
            document.getElementById('labSubject').value = '';
            document.getElementById('labHours').value = '';
            renderFacultyList();
        }
    }

    function removeFaculty(index) {
        faculties.splice(index, 1);
        renderFacultyList();
    }

    function shuffleFaculties() {
        for (let i = faculties.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [faculties[i], faculties[j]] = [faculties[j], faculties[i]];
        }
        renderFacultyList();
    }

    function generateTimetable() {
        const periodTimes = [
            "9.15-10.10", "10.10-11.05", "11.05-11.15", "11.15-12.05",
            "12.05-1.00", "1.00-2.00", "2.00-2.55", "2.55-3.40", "3.40-4.30"
        ];

        // Get department, year, semester values
        const department = document.getElementById('department').value || '';
        const year = document.getElementById('year').value || '';
        const semester = document.getElementById('semester').value || '';
        const classSection = document.getElementById('classSection') ? document.getElementById('classSection').value : '';

        // Create empty timetable
        let timetable = {};
        days.forEach((day, idx) => {
            timetable[`DAY ${idx+1}`] = Array(periods.length).fill("");
        });

        // Insert breaks after 2nd and 4th period
        days.forEach((day, dIdx) => {
            timetable[`DAY ${dIdx+1}`][2] = "Break"; // After 2nd period
            timetable[`DAY ${dIdx+1}`][5] = "Break"; // After 4th period
        });

        // Fill only the given count of each subject/lab
        faculties.forEach(fac => {
            let hoursToAssign = fac.hours;
            if (fac.isLab) {
                // Assign labs: continuous, must start at 1st or 5th period, and fill required hours
                let labAssigned = false;
                for (let d = 0; d < days.length && !labAssigned; d++) {
                    for (let startIdx of [0, 6]) {
                        let needed = fac.hours;
                        let canAssign = true;
                        let indices = [];
                        let idx = startIdx;
                        while (needed > 0 && idx < periods.length) {
                            if (periods[idx] === "Break") {
                                idx++;
                                continue;
                            }
                            if (timetable[`DAY ${d+1}`][idx]) {
                                canAssign = false;
                                break;
                            }
                            indices.push(idx);
                            idx++;
                            needed--;
                        }
                        if (canAssign && indices.length === fac.hours) {
                            indices.forEach(i => {
                                timetable[`DAY ${d+1}`][i] = fac.subject + " (Lab)";
                            });
                            labAssigned = true;
                            break;
                        }
                    }
                }
            } else {
                // Assign theory: distribute hours so the faculty has class every day (if possible), never consecutive, and not same period each day
                let daysAvailable = days.length;
                let perDay = Math.floor(fac.hours / daysAvailable);
                let extra = fac.hours % daysAvailable;
                let assigned = 0;
                // For each day, shuffle period indices to randomize period allocation
                for (let d = 0; d < days.length; d++) {
                    let toAssign = perDay + (extra > 0 ? 1 : 0);
                    if (extra > 0) extra--;
                    let assignedToday = 0;
                    // Get available period indices (excluding breaks)
                    let periodIndices = [];
                    for (let p = 0; p < periods.length; p++) {
                        if (periods[p] !== "Break") periodIndices.push(p);
                    }
                    // Shuffle period indices for randomness
                    for (let i = periodIndices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [periodIndices[i], periodIndices[j]] = [periodIndices[j], periodIndices[i]];
                    }
                    for (let idx = 0; idx < periodIndices.length && assignedToday < toAssign; idx++) {
                        let p = periodIndices[idx];
                        // No consecutive
                        if (
                            !timetable[`DAY ${d+1}`][p] &&
                            (p === 0 || timetable[`DAY ${d+1}`][p - 1] !== fac.subject) &&
                            (p === periods.length - 1 || timetable[`DAY ${d+1}`][p + 1] !== fac.subject)
                        ) {
                            // Also, avoid assigning the same period as previous days for this faculty
                            let samePeriodOtherDay = false;
                            for (let prevDay = 1; prevDay <= days.length; prevDay++) {
                                if (prevDay !== d + 1 && timetable[`DAY ${prevDay}`][p] === fac.subject) {
                                    samePeriodOtherDay = true;
                                    break;
                                }
                            }
                            if (samePeriodOtherDay) continue;
                            timetable[`DAY ${d+1}`][p] = fac.subject;
                            assigned++;
                            assignedToday++;
                            if (assigned === fac.hours) break;
                        }
                    }
                }
            }
        });

        // Collect only faculties who have at least one hour assigned in the timetable
        const assignedSubjects = new Set();
        Object.values(timetable).forEach(row => {
            row.forEach(cell => {
                if (cell && cell !== "Break") assignedSubjects.add(cell.replace("", ""));
            });
        });
        const assignedFaculties = faculties.filter(fac => assignedSubjects.has(fac.subject));

        // Render timetable
        let html = `
        <div class="mb-3 text-center">
            <strong>Department:</strong> ${department ? department : '<span style="color:#aaa;">Not specified</span>'} &nbsp; | &nbsp;
            <strong>Year:</strong> ${year ? year : '<span style="color:#aaa;">Not specified</span>'} &nbsp; | &nbsp;
            <strong>Semester:</strong> ${semester ? semester : '<span style="color:#aaa;">Not specified</span>'} &nbsp; | &nbsp;
            <strong>Class:</strong> ${classSection ? classSection : '<span style="color:#aaa;">Not specified</span>'}
        </div>
        <table class="table table-bordered timetable-table shadow-sm" style="width:auto;min-width:900px;">
            <thead>
                <tr>
                    <th rowspan="2">DAYS/TIME</th>
                    <th>1</th><th>2</th><th></th><th>3</th><th>4</th><th></th><th>5</th><th>6</th><th>7</th>
                </tr>
                <tr>
                    <th>9.15-10.10</th>
                    <th>10.10-11.05</th>
                    <th>11.05-11.15</th>
                    <th>11.15-12.05</th>
                    <th>12.05-1.00</th>
                    <th>1.00-2.00</th>
                    <th>2.00-2.55</th>
                    <th>2.55-3.40</th>
                    <th>3.40-4.30</th>
                </tr>
                <tr>
                    <th></th>
                    <th>AM</th>
                    <th>AM</th>
                    <th></th>
                    <th>AM</th>
                    <th>AM</th>
                    <th></th>
                    <th>PM</th>
                    <th>PM</th>
                    <th>PM</th>
                </tr>
            </thead>
            <tbody>
        `;
        Object.keys(timetable).forEach(day => {
            html += `<tr><th>${day}</th>`;
            timetable[day].forEach((cell, idx) => {
                if (periods[idx] === "Break") {
                    html += `<td style="background:#ffeeba;color:#856404;font-weight:bold;">Break</td>`;
                } else {
                    html += `<td>${cell || ""}</td>`;
                }
            });
            html += `</tr>`;
        });
        html += `</tbody></table>`;

        // Faculty legend: only those who have at least one hour in the timetable
        html += `<div style="margin-top:24px;"><b>Subject - Faculty Mapping (Assigned This Week)</b>
        <table class="table table-bordered" style="width:auto;min-width:400px;">
            <thead>
            <tr>
                <th>Subject</th>
                <th>Faculty Name</th>
                <th>Type</th>
                <th>Periods Allocated</th>
                <th>Theory Details</th>
                <th>Lab Details</th>
            </tr>
            </thead>
            <tbody>`;
        assignedFaculties.forEach(fac => {
            // Count periods allocated for this subject (including lab/theory distinction)
            let subjectLabel = fac.subject + (fac.isLab ? " (Lab)" : "");
            let periodCount = 0;
            Object.values(timetable).forEach(row => {
            row.forEach(cell => {
                if (cell === subjectLabel) periodCount++;
            });
            });
            // Show theory/lab details
            let theoryDetails = fac.isLab ? "" : `${fac.subject} (${fac.hours} hrs/week)`;
            let labDetails = fac.isLab ? `${fac.subject} (${fac.hours} hrs/week)` : "";
            html += `<tr>
                <td>${fac.subject}${fac.isLab ? " (Lab)" : ""}</td>
                <td>${fac.faculty}</td>
                <td>${fac.isLab ? "Lab" : "Theory"}</td>
                <td>${periodCount}</td>
                <td>${theoryDetails}</td>
                <td>${labDetails}</td>
                </tr>`;
        });
        html += `</tbody></table></div>`;

        document.getElementById('timetableResult').innerHTML = html;

        // Add Download Timetable button
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = "Download Timetable (Excel)";
        downloadBtn.className = "btn btn-outline-secondary mt-3";
        downloadBtn.onclick = downloadTimetableExcel;
        document.getElementById('timetableResult').appendChild(downloadBtn);
    }

    // Download timetable as Excel file
    function downloadTimetableExcel() {
        // Prepare data for Excel
        const table = document.querySelector('.timetable-table');
        if (!table) return;
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.table_to_sheet(table);

        // Add Timetable sheet first
        XLSX.utils.book_append_sheet(wb, ws, "Timetable");

        // Prepare faculty mapping data (second table in timetableResult)
        const mappingTable = document.querySelector('#timetableResult table.table-bordered:nth-of-type(2)');
        if (mappingTable) {
            let ws2 = XLSX.utils.table_to_sheet(mappingTable);
            XLSX.utils.book_append_sheet(wb, ws2, "Faculty Mapping");
        }

        // Add department, year, semester, class as a sheet
        const department = document.getElementById('department').value || '';
        const year = document.getElementById('year').value || '';
        const semester = document.getElementById('semester').value || '';
        const classSection = document.getElementById('classSection') ? document.getElementById('classSection').value : '';

        const infoData = [
            ["Department", department],
            ["Year", year],
            ["Semester", semester],
            ["Class", classSection]
        ];
        let wsInfo = XLSX.utils.aoa_to_sheet(infoData);
        XLSX.utils.book_append_sheet(wb, wsInfo, "Class Info");

        XLSX.writeFile(wb, "timetable.xlsx");
    }

    function downloadCSV() {
        let csv = "Day/Period," + periods.join(",") + "\n";
        days.forEach(day => {
            let row = [day];
            let table = document.querySelector('.timetable-table');
            let dayRow = Array.from(table.rows).find(r => r.cells[0] && r.cells[0].innerText === day);
            if (dayRow) {
                for (let i = 1; i < dayRow.cells.length; i++) {
                    row.push(dayRow.cells[i].innerText.replace(/\n/g, ' '));
                }
            }
            csv += row.join(",") + "\n";
        });
        let blob = new Blob([csv], { type: 'text/csv' });
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "timetable.csv";
        link.click();
    }

    function renderFacultyList() {
        let html = '<div class="faculty-header">Faculty Assignments:</div><ul class="list-group">';
        faculties.forEach((f, i) => {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${f.faculty} - <span style="color:#2a5298;font-weight:600">${f.subject}</span> 
                        <span class="badge bg-info text-dark ms-2">${f.hours} hrs/week${f.isLab ? ' (Lab)' : ''}</span></span>
                        <button class="btn btn-sm btn-danger" onclick="removeFaculty(${i})">Remove</button>
                    </li>`;
        });
        html += '</ul>';
        document.getElementById('facultyList').innerHTML = html;
    }
</script>
</body>
</html>
